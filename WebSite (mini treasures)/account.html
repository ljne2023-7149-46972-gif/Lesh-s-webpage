<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account - Mini Treasures</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="cdn/tailwind.js"></script>
    <script src="cdn/feather-unpkg.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <img class="h-12 w-auto" src="pictures/mtlogo.png" alt="Mini Treasures Logo">
                        <span class="ml-2 text-xl font-bold text-pink-500">Mini Treasures</span>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="index.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Home</a>
                        <a href="shop.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Shop</a>
                        <a href="collections.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">Collections</a>
                        <a href="about.html" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">About</a>
                    </div>
                </div>
                <div class="hidden sm:ml-6 sm:flex sm:items-center">
                    <a href="search.html" class="bg-white p-1 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none">
                        <i data-feather="search"></i>
                    </a>
                    <a href="account.html" class="ml-3 bg-white p-1 rounded-full text-pink-500 hover:text-pink-700 focus:outline-none">
                        <i data-feather="user"></i>
                    </a>
                        <a href="cart.html" class="ml-3 bg-white p-1 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none relative">
                            <i data-feather="shopping-cart"></i>
                            <span class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-pink-500 rounded-full"><span id="cart-count">0</span></span>
                        </a>
                        <span id="user-welcome" class="ml-4 text-sm text-gray-700 hidden"></span>
                        <button id="logout-btn" class="ml-3 px-3 py-1 text-sm bg-gray-100 rounded hidden">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-16 px-4 sm:py-24 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-extrabold tracking-tight text-gray-900 mb-8">My Account</h1>
        <div class="bg-white rounded-lg shadow p-6">
            <div class="md:flex">
                <aside class="md:w-1/4 mb-6 md:mb-0">
                    <nav class="space-y-2">
                        <button data-tab="purchases" class="tab-btn w-full text-left px-4 py-2 rounded-md bg-pink-50 text-pink-600 font-medium">My purchases</button>
                        <button data-tab="to-receive" class="tab-btn w-full text-left px-4 py-2 rounded-md hover:bg-gray-100">To receive</button>
                        <button data-tab="to-ship" class="tab-btn w-full text-left px-4 py-2 rounded-md hover:bg-gray-100">To ship</button>
                        <button data-tab="settings" class="tab-btn w-full text-left px-4 py-2 rounded-md hover:bg-gray-100">Settings</button>
                        <button data-tab="chat" class="tab-btn w-full text-left px-4 py-2 rounded-md hover:bg-gray-100">Chat</button>
                    </nav>
                </aside>
                <main class="md:flex-1 md:pl-6">
                    <section id="purchases" class="account-tab">
                        <h2 class="text-xl font-semibold mb-4">My purchases</h2>
                        <div id="purchases-list" class="space-y-4 text-sm text-gray-700">
                            <p class="text-gray-500">You have no purchases yet.</p>
                        </div>
                    </section>

                    <section id="to-receive" class="account-tab hidden">
                        <h2 class="text-xl font-semibold mb-4">To receive</h2>
                        <div id="to-receive-list" class="space-y-4 text-sm text-gray-700">
                            <p class="text-gray-500">No incoming shipments.</p>
                        </div>
                    </section>

                    <section id="to-ship" class="account-tab hidden">
                        <h2 class="text-xl font-semibold mb-4">To ship</h2>
                        <div id="to-ship-list" class="space-y-4 text-sm text-gray-700">
                            <p class="text-gray-500">No orders to ship.</p>
                        </div>
                    </section>

                    <section id="settings" class="account-tab hidden">
                        <h2 class="text-xl font-semibold mb-4">Settings</h2>
                        <form id="settings-form" class="space-y-4 max-w-md">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Full name</label>
                                <input id="settings-name" class="mt-1 block w-full px-3 py-2 border rounded" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input id="settings-email" class="mt-1 block w-full px-3 py-2 border rounded" disabled />
                            </div>
                            <div>
                                <button id="save-settings" type="button" class="px-4 py-2 bg-pink-600 text-white rounded">Save</button>
                            </div>
                        </form>
                    </section>

                    <section id="chat" class="account-tab hidden">
                        <h2 class="text-xl font-semibold mb-4">Chat</h2>
                        <div id="chat-window" class="h-64 overflow-auto p-4 border rounded bg-gray-50 space-y-2 mb-4"></div>
                        <div class="flex space-x-2">
                            <input id="chat-input" class="flex-1 px-3 py-2 border rounded" placeholder="Message the support team..." />
                            <button id="chat-send" class="px-4 py-2 bg-pink-600 text-white rounded">Send</button>
                        </div>
                    </section>
                </main>
            </div>
        </div>

        <script>
            (function(){
                function showTab(id){
                    document.querySelectorAll('.account-tab').forEach(s=> s.classList.add('hidden'));
                    const el = document.getElementById(id);
                    if(el) el.classList.remove('hidden');
                    // highlight active
                    document.querySelectorAll('.tab-btn').forEach(b=> b.classList.remove('bg-pink-50','text-pink-600'));
                    const btn = document.querySelector('.tab-btn[data-tab="'+id+'"]');
                    if(btn) btn.classList.add('bg-pink-50','text-pink-600');
                }

                // attach tab handlers
                document.querySelectorAll('.tab-btn').forEach(b=>{
                    b.addEventListener('click',(e)=>{ showTab(b.getAttribute('data-tab')); });
                });

                // load current user into settings
                function loadSettings(){
                    const email = localStorage.getItem('mt_userEmail');
                    const users = JSON.parse(localStorage.getItem('mt_users')||'{}');
                    const name = (users[email] && users[email].name) ? users[email].name : '';
                    if(document.getElementById('settings-name')) document.getElementById('settings-name').value = name;
                    if(document.getElementById('settings-email')) document.getElementById('settings-email').value = email || '';
                }

                document.getElementById('save-settings').addEventListener('click', ()=>{
                    const email = document.getElementById('settings-email').value;
                    if(!email) return alert('No user logged in');
                    const users = JSON.parse(localStorage.getItem('mt_users')||'{}');
                    users[email] = users[email] || {};
                    users[email].name = document.getElementById('settings-name').value.trim();
                    localStorage.setItem('mt_users', JSON.stringify(users));
                    alert('Settings saved');
                    // update user-welcome if present
                    const welcome = document.getElementById('user-welcome');
                    if(welcome){ welcome.textContent = 'Welcome, ' + users[email].name; welcome.classList.remove('hidden'); }
                });

                // simple chat stored in localStorage per user
                function loadChat(){
                    const email = localStorage.getItem('mt_userEmail') || 'guest';
                    const key = 'mt_chat_' + email;
                    const msgs = JSON.parse(localStorage.getItem(key)||'[]');
                    const win = document.getElementById('chat-window');
                    win.innerHTML = '';
                    msgs.forEach(m=>{
                        const div = document.createElement('div');
                        div.className = 'text-sm';
                        div.textContent = m;
                        win.appendChild(div);
                    });
                    win.scrollTop = win.scrollHeight;
                }
                document.getElementById('chat-send').addEventListener('click', ()=>{
                    const email = localStorage.getItem('mt_userEmail') || 'guest';
                    const key = 'mt_chat_' + email;
                    const msg = document.getElementById('chat-input').value.trim();
                    if(!msg) return;
                    const msgs = JSON.parse(localStorage.getItem(key)||'[]');
                    msgs.push((localStorage.getItem('mt_userEmail')||'Guest')+': '+msg);
                    localStorage.setItem(key, JSON.stringify(msgs));
                    document.getElementById('chat-input').value = '';
                    loadChat();
                });

                // populate purchases/to-receive/to-ship from localStorage orders if present
                function renderOrderCard(o){
                    const items = (o.items||[]).map(it=>`${it.title} x${it.qty||1}`).join('<br>');
                    const date = o.date ? new Date(o.date).toLocaleString() : '';
                    const eta = o.deliveryDate ? new Date(o.deliveryDate).toLocaleString() : '';
                    const seller = o.seller || 'MiniTreasures@websystem.com';
                                return `<div id="order-${o.id}" class="p-3 border rounded account-card">
                                                        <div class="font-medium">Order ${o.id}</div>
                                                        <div class="text-sm text-gray-700">${items}</div>
                                                        <div class="text-sm text-gray-500">Status: ${o.status||'Purchased'}</div>
                                                        ${eta?`<div class="text-sm text-pink-600">Delivery ETA: ${eta}</div>`:''}
                                                        <div class="text-xs text-gray-400">Seller: ${seller}</div>
                                                        <div class="text-xs text-gray-400">${date}</div>
                                                        <div class="mt-3">
                                                            <a href="receipt.html?id=${o.id}" class="inline-block px-3 py-1 mr-2 text-sm bg-white border rounded">Open Invoice</a>
                                                            <a href="account.html?tab=purchases&order=${o.id}" class="inline-block px-3 py-1 text-sm bg-white border rounded">View Details</a>
                                                        </div>
                                                </div>`;
                }

                function loadOrders(){
                    const email = (localStorage.getItem('mt_userEmail') || '').toLowerCase();
                    let orders = JSON.parse(localStorage.getItem('mt_orders')||'[]');
                    // normalize old seller values (replace legacy 'store@mini.local')
                    let changed = false;
                    orders.forEach(o=>{
                        if(o && o.seller === 'store@mini.local'){
                            o.seller = 'MiniTreasures@websystem.com';
                            changed = true;
                        }
                    });
                    if(changed){ localStorage.setItem('mt_orders', JSON.stringify(orders)); }
                        const my = orders.filter(o=> (o.email||'').toLowerCase() === email);
                    const purchasesList = document.getElementById('purchases-list');
                    const toReceiveList = document.getElementById('to-receive-list');
                    const toShipList = document.getElementById('to-ship-list');
                    if(purchasesList){
                        if(my.length===0) purchasesList.innerHTML = '<p class="text-gray-500">You have no purchases yet.</p>';
                        else purchasesList.innerHTML = my.map(o=> renderOrderCard(o)).join('');
                    }
                    if(toReceiveList){
                        // treat 'paid' as incoming (waiting to be shipped) as well as shipped/in-transit
                        const incoming = my.filter(o=> ['shipped','in-transit','paid'].includes(o.status));
                        toReceiveList.innerHTML = incoming.length===0 ? '<p class="text-gray-500">No incoming shipments.</p>' : incoming.map(o=> renderOrderCard(o)).join('');
                    }
                    if(toShipList){
                        const toShip = orders.filter(o=> o.seller === (localStorage.getItem('mt_userEmail')||'') && o.status === 'paid');
                        toShipList.innerHTML = toShip.length===0 ? '<p class="text-gray-500">No orders to ship.</p>' : toShip.map(o=> renderOrderCard(o)).join('');
                    }
                }

                // initial
                loadSettings(); loadChat(); loadOrders();
                // show default tab or honor query param
                const params = new URLSearchParams(window.location.search);
                const reqTab = params.get('tab');
                const reqOrder = params.get('order');
                if(reqTab) showTab(reqTab); else showTab('purchases');
                // if an order id was provided, scroll to and highlight it
                if(reqOrder){
                    setTimeout(()=>{
                        const el = document.getElementById('order-' + reqOrder);
                        if(el){
                            try{ el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }catch(e){}
                            el.style.boxShadow = '0 0 0 4px rgba(236,72,153,0.12)';
                            setTimeout(()=>{ el.style.boxShadow = ''; }, 3500);
                        }
                    }, 200);
                }
            })();
        </script>
    </div>

    <script>
        feather.replace();
    </script>
    <script src="cdn/cart.js"></script>
</body>
</html>